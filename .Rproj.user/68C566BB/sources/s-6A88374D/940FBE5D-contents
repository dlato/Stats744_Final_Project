# Exploratory graphics for selection data
library(tidyverse)
library(data.table)

theme_set(theme_bw() + theme(strip.background =element_rect(fill="#e7e5e2")) +
            theme(strip.text = element_text(size =10)) +
            #theme(plot.title = element_text(hjust = 0.5), 
            theme(plot.title = element_text(), 
                  panel.background = element_rect(fill = "white", colour = NA), 
                  panel.grid.major = element_line(colour = "grey90", size = 0.2), 
                  panel.grid.minor = element_line(colour = "grey98", size = 0.5), 
                  panel.spacing = unit(0.25, "lines"), 
                  axis.text=element_text(size=10),
                  legend.position="top") 
)


# Load in data
#list of files
file_list <- list.files(path = "./data/",
                        pattern = "*_selection_data.csv",
                        full.names = T)
selection_dat <- tibble(bacteria = file_list) %>% # create a data frame
  # holding the file names
  mutate(file_contents = map(bacteria,          # read files into
                             ~ read_csv(.))) # a new data column
selection_df <- unnest(selection_dat, cols = c(file_contents))

#change the file names to bacteria names
selection_df <- selection_df %>%
  mutate_if(is.character, str_replace_all, pattern = '^./data/bass_selection_data.csv', replacement = 'bass')
selection_df <- selection_df %>%
  mutate_if(is.character, str_replace_all, pattern = '^./data/ecoli_selection_data.csv', replacement = 'ecoli')
selection_df <- selection_df %>%
  mutate_if(is.character, str_replace_all, pattern = '^./data/strep_selection_data.csv', replacement = 'strep')
selection_df <- selection_df %>%
  mutate_if(is.character, str_replace_all, pattern = '^./data/sinoC_selection_data.csv', replacement = 'sinoC')
selection_df <- selection_df %>%
  mutate_if(is.character, str_replace_all, pattern = '^./data/pSymA_selection_data.csv', replacement = 'pSymA')
selection_df <- selection_df %>%
  mutate_if(is.character, str_replace_all, pattern = '^./data/pSymB_selection_data.csv', replacement = 'pSymB')

#combine dN, dS, and omega data into one column for eventual plotting
selection_df <- selection_df %>% 
  gather(sel_class, val, dN:omega) %>%
  mutate(sel_class = gsub("sel_class", "", sel_class)) %>%
  arrange(bacteria, gene_name, sel_class, midpoint, tmp_pos)

#remove NAs to avoid warnings
selection_df_no_NA <- tidyr::drop_na(selection_df,val)

#reorder by median omega
selection_df_no_NA <- (selection_df_no_NA
             %>% group_by(bacteria)
             %>% mutate(omegaval=median(val[sel_class=="omega"]))
             %>% ungroup()
             %>% mutate(bacteria = reorder(bacteria,omegaval))
             %>% select(-omegaval)
)

